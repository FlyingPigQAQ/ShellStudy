# 端口映射
端口映射（Port Forwarding）是一种网络技术，允许外部用户通过网络访问位于内部网络中的服务或设备。它通常用于家庭网络、企业网络和数据中心等场景中，以便将外部请求转发到内部网络的特定端口和主机上。

### 1. 基本概念
#### 端口（Port）
+ **端口** 是计算机网络上的通信端点。每个端口由一个16位的数字表示，范围从0到65535。
+ **知名端口**：0-1023，通常用于知名服务（如HTTP的80端口，HTTPS的443端口）。
+ **注册端口**：1024-49151，通常用于注册服务和用户应用程序。
+ **动态端口**：49152-65535，通常用于临时或私有用途。

#### 内外网
+ **外网（广域网，WAN）**：通常是指互联网。
+ **内网（局域网，LAN）**：通常是指家庭或公司内部网络。
  
### 2. 端口映射的原理
端口映射的核心在于网络设备（如路由器或防火墙）将外部请求的特定端口重定向到内部网络中相应的设备和端口。这个过程主要通过以下步骤实现：

1. 接收外部请求：路由器接收到来自外网的请求，该请求指向路由器的某个端口。
2. 查找映射规则：路由器检查预先配置的端口映射规则，以确定如何处理该请求。
3. 重定向请求：根据映射规则，将请求重定向到内网中对应设备的指定端口。
4. 返回响应：内网设备处理请求并返回响应，路由器将响应转发回外部请求者。
   
### 3. 端口映射的类型
#### 静态端口映射
+ **静态端口映射** 是一种固定的映射关系，即特定的外部端口始终映射到内网中某个固定的IP地址和端口。
+ 例如，将外部端口8080映射到内部服务器192.168.1.100的80端口上。

#### 动态端口映射（PAT）
+ **动态端口映射（端口地址转换，PAT）** 是一种将多个内部IP地址和端口映射到一个或多个外部端口的技术。通常用于网络地址转换（NAT）。
+ 例如，多个内网设备通过不同的端口号共享一个外部IP地址。
  
### 4. 端口映射的配置
下面是一些常见设备上配置端口映射的示例：

#### 在路由器上配置端口映射
1. **登录路由器管理界面**：通过浏览器访问路由器的管理IP地址（通常是192.168.1.1或192.168.0.1），并使用管理员账号登录。
2. **找到端口映射设置**：通常在“高级设置”或“应用和游戏”选项下。
3. **添加映射规则**：
+ 输入外部端口（如8080）。
+ 输入内部IP地址（如192.168.1.100）。
+ 输入内部端口（如80）。
+ 选择协议（TCP、UDP或两者）。
4. **保存设置**：保存并应用设置。
   
#### 在Linux上使用iptables配置端口映射
```shell
#bash
# 将外部TCP 8080端口映射到内部192.168.1.100的80端口
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80

# 允许流量从内部192.168.1.100的80端口返回到外部
sudo iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
```

参数解释：
```shell
# 将外部TCP 8080端口映射到内部192.168.1.100的80端口
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80
```
##### 具体含义

这个命令使用 iptables 将来自外部网络的 TCP 端口 8080 的流量重定向到内部网络中 IP 地址为 192.168.1.100 的主机的端口 80。

这条命令的作用是：将所有进入本机 8080 端口的 TCP 数据包重定向到 IP 地址为 192.168.1.100 的主机的 80 端口。

##### 参数含义

+ sudo：以超级用户权限运行命令。
+ iptables：是 Linux 系统中的一个用户空间实用程序，允许系统管理员配置内核防火墙。它是大多数 Linux 发行版上默认的防火墙工具，用于定义如何处理进出系统的数据包。
+ -t nat：指定使用 nat 表（网络地址转换表），用于地址转换。其中-t是--table 选项的缩写，用于指定要操作的表。nat 表用于网络地址转换，用于源 NAT（SNAT）和目标 NAT（DNAT）。
+ -A PREROUTING：在 PREROUTING 链中追加一条规则。PREROUTING 链用于处理数据包刚进入防火墙时的规则。其中-a是--append 选项的缩写，用于在指定的表或链中追加一条规则。PREROUTING 链在数据包路由决策之前处理数据包。
+ -p tcp：指定规则适用于 TCP 协议。其中-p是--protocol 选项的缩写，用于指定协议。tcp 表示传输控制协议（Transmission Control Protocol）。
+ --dport 8080：指定规则适用于目标端口为 8080 的数据包。其中--dport是--destination-port 选项的缩写，用于指定目标端口。8080 是目标端口号。
+ -j DNAT：指定目标操作为 DNAT（目标网络地址转换），即更改数据包的目标地址。其中-j是--jump 选项的缩写，用于指定目标操作。DNAT 表示目标网络地址转换（Destination Network Address Translation）。
+ --to-destination 192.168.1.100:80：将目标地址和端口重定向到 192.168.1.100 的 80 端口。

```shell
# 允许流量从内部192.168.1.100的80端口返回到外部
sudo iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
```
##### 具体含义

这个命令允许流量从内部网络中 IP 地址为 192.168.1.100 的主机的端口 80 返回到外部网络。该规则确保 TCP 会话可以正常建立和维持。

这条命令的作用是：在 FORWARD 链中追加一条规则，允许所有目的地址为 192.168.1.100 的 TCP 数据包通过，其目标端口为 80，且这些数据包的状态为 NEW、ESTABLISHED 或 RELATED。

##### 参数含义

+ sudo：以超级用户权限运行命令。
+ iptables：是 Linux 系统中的一个用户空间实用程序，允许系统管理员配置内核防火墙。它是大多数 Linux 发行版上默认的防火墙工具，用于定义如何处理进出系统的数据包。
+ -A FORWARD：在 FORWARD 链中追加一条规则。其中-a是--append 选项的缩写，用于在指定的表或链中追加一条规则。FORWARD 链处理转发通过本地系统的数据包。
+ -p tcp：指定规则适用于 TCP 协议。其中-p是--protocol 选项的缩写，用于指定协议。tcp 表示传输控制协议（Transmission Control Protocol）。
+ -d 192.168.1.100：指定规则适用于目标地址为 192.168.1.100 的数据包。其中-d是--destination 的缩写，用于指定目标 IP 地址。
+ --dport 80：指定规则适用于目标端口为 80 的数据包。其中--dport是--destination-port 选项的缩写，用于指定目标端口。80 是目标端口号。
+ -m state：使用状态匹配模块（state match module）。其中-m 是 --match 的缩写，用于指定匹配条件。
+ --state NEW,ESTABLISHED,RELATED：--state 是用于指定要匹配的数据包状态。指定规则适用于状态为 NEW（新连接）、ESTABLISHED（已建立连接）和 RELATED（相关连接）的数据包。
+ -j ACCEPT：指定目标操作为 ACCEPT，ACCEPT 表示接受数据包并允许其通过。其中-j是--jump 选项的缩写，用于指定目标操作。

### 5. 端口映射的应用场景
+ **远程访问**：允许外部用户通过互联网访问内网中的服务，如远程桌面、FTP服务器等。
+ **托管服务**：通过端口映射在家庭或公司网络中托管网站或其他服务。
+ **游戏服务器**：在内网中设置游戏服务器，允许外部玩家连接和参与游戏。
### 6. 安全性考虑
端口映射虽然方便，但也带来了一些安全风险：

+ **暴露内网服务**：不安全的映射可能使内网服务暴露在外网，增加被攻击的风险。
+ **使用强密码和加密**：确保映射的服务使用强密码和加密通信。
+ **限制访问**：使用防火墙规则限制访问来源，避免不必要的暴露。
通过合理配置和管理，端口映射可以在保证安全的前提下，极大地方便内外网的通信和服务访问。

## 应用场景

远程访问是端口映射（Port Forwarding）技术的一个非常常见的应用场景。它允许外部用户通过互联网访问位于内部网络中的资源，如文件、应用程序、服务器等。以下是详细的介绍和步骤。

### 远程访问场景详解

#### 1. 远程桌面访问

**场景**：您在办公室的电脑上配置了远程桌面协议（RDP），希望在家中通过互联网访问办公室的电脑。

**步骤**：

1. **配置远程桌面**：
   - 在目标电脑上启用远程桌面功能。
   - 确保目标电脑有一个静态IP地址，或者在路由器上为其配置永久DHCP租约。

2. **设置端口映射**：
   - 登录办公室路由器的管理界面。
   - 找到端口映射（Port Forwarding）设置。
   - 添加一条新的映射规则：
     - 外部端口：3389（RDP默认端口）。
     - 内部IP地址：目标电脑的IP地址（例如192.168.1.100）。
     - 内部端口：3389。
     - 协议：TCP。
   - 保存设置并重启路由器以应用更改。

3. **远程连接**：
   - 在家中打开远程桌面客户端。
   - 输入办公室路由器的外部IP地址和端口（例如：80.101.23.45:3389）。
   - 输入目标电脑的用户名和密码进行连接。

#### 2. 访问家庭NAS（网络附加存储）

**场景**：您在家中安装了一个NAS设备，想要在外出时通过互联网访问它来获取或者上传文件。

**步骤**：

1. **配置NAS设备**：
   - 在NAS设备上启用远程访问功能。
   - 设置一个静态IP地址给NAS设备（例如192.168.1.200）。

2. **设置端口映射**：
   - 登录家庭路由器的管理界面。
   - 找到端口映射（Port Forwarding）设置。
   - 添加一条新的映射规则：
     - 外部端口：5000（假设NAS的管理端口）。
     - 内部IP地址：NAS设备的IP地址（例如192.168.1.200）。
     - 内部端口：5000。
     - 协议：TCP。
   - 保存设置并重启路由器以应用更改。

3. **远程连接**：
   - 在外出时，通过浏览器访问家庭路由器的外部IP地址和端口（例如：http://80.101.23.45:5000）。
   - 输入NAS设备的登录凭据进行访问。

#### 3. 远程摄像头监控

**场景**：您在家中安装了网络摄像头，想要在外出时通过互联网查看家中的状况。

**步骤**：

1. **配置网络摄像头**：
   - 在摄像头设置中启用远程访问功能。
   - 配置一个静态IP地址给摄像头（例如192.168.1.150）。

2. **设置端口映射**：
   - 登录家庭路由器的管理界面。
   - 找到端口映射（Port Forwarding）设置。
   - 添加一条新的映射规则：
     - 外部端口：8080（假设摄像头的访问端口）。
     - 内部IP地址：摄像头的IP地址（例如192.168.1.150）。
     - 内部端口：8080。
     - 协议：TCP。
   - 保存设置并重启路由器以应用更改。

3. **远程连接**：
   - 在外出时，通过浏览器或摄像头的专用应用程序访问家庭路由器的外部IP地址和端口（例如：http://80.101.23.45:8080）。
   - 输入摄像头的登录凭据进行查看。

### 安全性考虑

远程访问虽然方便，但也带来了一些安全风险。以下是一些安全措施：

1. **使用强密码**：确保所有远程访问服务使用强密码，避免简单密码被暴力破解。
2. **启用双因素认证**：如果支持，启用双因素认证以增加安全性。
3. **限制IP地址**：在路由器或防火墙上设置规则，限制哪些IP地址可以访问映射的端口。
4. **使用VPN**：配置VPN（虚拟专用网络）以加密通信，避免直接暴露端口。
5. **定期更新**：确保所有设备和软件定期更新，修补已知的安全漏洞。

通过合理的配置和安全措施，端口映射可以在远程访问场景中提供极大的方便，同时保持较高的安全性。